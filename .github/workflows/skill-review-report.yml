name: Skill Review Report

on:
  schedule:
    - cron: "0 9 * * 1"
  workflow_dispatch:
    inputs:
      max_skills:
        description: "Max skills to process"
        required: false
        default: "50"
      model_id:
        description: "Model ID for GitHub Models"
        required: false
        default: "openai/gpt-4.1"

permissions:
  contents: read
  issues: write
  models: read

concurrency:
  group: skill-review-report
  cancel-in-progress: false

jobs:
  generate-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install gh-models extension
        env:
          GH_TOKEN: ${{ github.token }}
        run: gh extension install github/gh-models

      - name: Generate report
        env:
          GH_TOKEN: ${{ github.token }}
          MAX_SKILLS: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.max_skills || '50' }}
          MODEL_ID: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.model_id || 'openai/gpt-4.1' }}
        run: python scripts/generate_skill_review_report.py

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: skill-review-report
          path: |
            reports/skill-review-report.md
            reports/skill-suggestions.json

      - name: Create parent and sub-issues for Copilot
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e

          PARENT_TITLE="chore: skill improvements from scheduled review"
          
          # Check for existing open parent issue to avoid duplicates
          EXISTING_PARENT=$(gh issue list --state open --label "copilot" --search "in:title \"$PARENT_TITLE\"" --json number,title --jq '.[] | select(.title == "'"$PARENT_TITLE"'") | .number' | head -1)
          
          if [ -n "$EXISTING_PARENT" ]; then
            echo "Parent issue #$EXISTING_PARENT already exists. Skipping creation."
            exit 0
          fi

          # Create parent issue first with placeholder body
          PARENT_BODY=$(cat << 'EOF'
          This issue tracks improvements to code review skill instructions identified by the weekly automated review.

          **Goal:** Improve the quality and clarity of skill instructions used by AI coding agents for code review.

          ## Sub-issues

          _Sub-issues will be listed below after creation._
          EOF
          )

          PARENT_URL=$(gh issue create \
            --title "$PARENT_TITLE" \
            --body "$PARENT_BODY" \
            --label "copilot")
          
          PARENT_NUMBER=$(echo "$PARENT_URL" | grep -oE '[0-9]+$')
          echo "Created parent issue #$PARENT_NUMBER"

          # Clear temp file for sub-issue references
          rm -f /tmp/sub_issues.txt
          touch /tmp/sub_issues.txt

          # Read skill suggestions from JSON and create sub-issues
          # Use while loop with read to handle skill names properly
          jq -r 'keys[]' reports/skill-suggestions.json | while IFS= read -r skill_name; do
            SKILL_TITLE="Improve ${skill_name} skill â€“ scheduled review"
            
            # Check for existing open sub-issue to avoid duplicates
            EXISTING_SUB=$(gh issue list --state open --label "copilot" --search "in:title \"$SKILL_TITLE\"" --json number,title --jq '.[] | select(.title == "'"$SKILL_TITLE"'") | .number' | head -1)
            
            if [ -n "$EXISTING_SUB" ]; then
              echo "Sub-issue for $skill_name (#$EXISTING_SUB) already exists. Skipping."
              echo "- [ ] #${EXISTING_SUB} ${SKILL_TITLE}" >> /tmp/sub_issues.txt
              continue
            fi

            # Get suggestions for this skill
            suggestions=$(jq -r --arg skill "$skill_name" '.[$skill]' reports/skill-suggestions.json)
            
            # Create sub-issue body
            SUB_BODY=$(cat << EOF
          <!-- scheduled-skill-review:${skill_name} -->

          Apply the following improvements to \`skills/${skill_name}/SKILL.md\`:

          ${suggestions}

          ---

          Parent issue: #${PARENT_NUMBER}
          EOF
          )

            SUB_URL=$(gh issue create \
              --title "$SKILL_TITLE" \
              --body "$SUB_BODY" \
              --label "copilot")
            
            SUB_NUMBER=$(echo "$SUB_URL" | grep -oE '[0-9]+$')
            echo "Created sub-issue #$SUB_NUMBER for $skill_name"
            
            echo "- [ ] #${SUB_NUMBER} ${SKILL_TITLE}" >> /tmp/sub_issues.txt
            
            # Small delay to avoid rate limiting
            sleep 1
          done

          # Read sub-issues from temp file
          SUB_ISSUES=$(cat /tmp/sub_issues.txt)

          # Update parent issue body with sub-issue references
          UPDATED_PARENT_BODY=$(cat << EOF
          This issue tracks improvements to code review skill instructions identified by the weekly automated review.

          **Goal:** Improve the quality and clarity of skill instructions used by AI coding agents for code review.

          ## Sub-issues

          ${SUB_ISSUES}
          EOF
          )

          gh issue edit "$PARENT_NUMBER" --body "$UPDATED_PARENT_BODY"
          echo "Updated parent issue #$PARENT_NUMBER with sub-issue references"

          # Comment on parent issue to trigger Copilot agent
          gh issue comment "$PARENT_NUMBER" --body "@copilot"
          echo "Commented on parent issue to trigger Copilot agent"
